### 1、程序的前世今生

硬件部分：

计算机硬件结构从早期的单一总线，后来由于CPU核心频率提升，增加与内存频率一致的系统总线，CPU采用倍频的方式与系统总线通信，后面为了协调高速设备与低速设备（如IO）之间的通信，设计高速的北桥芯片与低速的南桥芯片，形成了多总线结构与对应控制芯片的硬件结构。

CPU频率提升遇到瓶颈后出现了SMP和多核。

软件部分：

操作系统从单程序到多道程序到分时系统到现代抢占式分时系统。

引入了分页、虚拟、多线程等概念。

关于线程：私有资源有栈(包括函数参数、局部变量)、TLS数据、pc寄存器，共享的有全局变量、堆数据、静态变量、代码、打开的文件等资源。

### 2、编译与链接

C/C++程序编译过程分为预处理、编译、汇编、链接四个过程。

#### 2.1预处理

主要处理“#”预编译指令，如include、define等，唯一保留的是#paragma。删除了注释以及添加了行号、文件名。

#### 2.2 编译

词法分析：将代码扫描为一个个词并用有限状态机表示。

语法分析：生成语法树，可以检测表达式不合法错误。

语义分析：判断类型匹配等语义上的错误。

中间语言生成：优化语法树生成中间代码（如三地址码），这里是源代码层级的优化。

中间代码使得编译器可以被分为前端和后端。编译器前端负责产生机器无关的中间代码，编译器后端将中间代码转换成目标机器代码。这样对于一些可以跨平台的编译器而言，它们可以针对不同的平台使用同一个前端和针对不同机器平台的数个后端。

#### 2.3 汇编

目标代码生成与优化：编译器后端包括代码生成器与目标代码优化器。代码生成器将中间代码转换成目标机器代码。

将汇编代码.s转变成机器可执行代码.o。

#### 2.4 链接

随着软件规模增大，开始将代码划分模块，各模块单独开发、编译、测试，模块间的组合需要依靠符号来通信，拼接模块的过程为链接。

链接包括地址与空间分配、符号决议(符号绑定)、重定位。

例如B中声明了A的一个变量，编译目标文件B时，会先讲该变量分配一个地址为0的地址，在链接时修正改地址为正确的内存地址（重定位）。

### 3、目标文件格式

现代可执行文件主要格式为Windows PE和Linux ELF，均为COFF格式变种。后续介绍ELF。

注意除了可执行文件，静态链接库与动态链接库也是按照可执行文件格式存储。

ELF文件头：魔数、机器

.text section:程序机器指令

.data section:

.bss section:

...

可以用objdump分析。
